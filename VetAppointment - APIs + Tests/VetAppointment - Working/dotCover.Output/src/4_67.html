<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>D:\Facultate\Anul_3\.NET\VetAppointment_S12\VetAppointment - APIs + Tests\VetAppointment - Working\VetAppointment.Integration.Test\VetClinicsControllerTests_.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
#nullable disable
using Microsoft.AspNetCore.Mvc.Testing;
using Microsoft.AspNetCore.TestHost;
using Microsoft.EntityFrameworkCore;
using Microsoft.Extensions.DependencyInjection;
using Microsoft.Extensions.Options;
using VetAppointment.API.Controllers;
using VetAppointment.Domain.Enums;
using VetAppointment.Infrastructure.Data;

namespace VetAppointment.Integration.Tests
{
    public class VetClinicsControllerTests : BaseIntegrationTests, IDisposable
    {
        private const string ApiURL = &quot;v1/api/vetclinics&quot;;

        public VetClinicsControllerTests(WebApplicationFactory&lt;VetClinicsController&gt; factory) : base(factory)
        {
        }

        [Fact]
        public async void When_CreateClinic_Then_ShouldReturnClinicInTheGetRequestAsync()
        {
            var HttpClient = _factory.WithWebHostBuilder(builder =&gt;
            {
                builder.ConfigureTestServices(services =&gt;
                {
                    services.AddDbContext&lt;DatabaseContext&gt;(options =&gt;
                    {
                        options.UseSqlite(&quot;Data Source = VetAppointmentTest7.db&quot;);
                    });
                });
            }).CreateClient(new WebApplicationFactoryClientOptions
            {
                AllowAutoRedirect = false,
            });
            DbContextOptions&lt;DatabaseContext&gt; options = new DbContextOptionsBuilder&lt;DatabaseContext&gt;()
                .UseSqlite(&quot;Data Source = VetAppointmentTest7.db&quot;).Options;
            DatabaseContext db = new DatabaseContext(options);
            db.RemoveRange(db.Vets.ToList());
            db.RemoveRange(db.Pets.ToList());
            db.RemoveRange(db.Appointments.ToList());
            db.RemoveRange(db.VetClinics.ToList());
            db.SaveChanges();

            // Arrange
            CreateVetClinicDto vetClinicDto = CreateClinitSUT();

            // Act
            var createClinicResponse = await HttpClient.PostAsJsonAsync(ApiURL, vetClinicDto);
            var getClinicResult = await HttpClient.GetAsync(ApiURL);

            // Assert
            createClinicResponse.EnsureSuccessStatusCode();
            createClinicResponse.StatusCode.Should().Be(HttpStatusCode.Created);

            getClinicResult.EnsureSuccessStatusCode();
            var clinics = await getClinicResult.Content.ReadFromJsonAsync&lt;List&lt;VetClinicDto&gt;&gt;();

            clinics.Should().HaveCount(1);
            clinics.Should().NotBeNull();
        }

        [Fact]
        public async Task When_RegisterPetsFamilyToClinic_Then_ShouldSavePetsInClinicAsync()
        {
            var HttpClient = _factory.WithWebHostBuilder(builder =&gt;
            {
                builder.ConfigureTestServices(services =&gt;
                {
                    services.AddDbContext&lt;DatabaseContext&gt;(options =&gt;
                    {
                        options.UseSqlite(&quot;Data Source = VetAppointmentTest6.db&quot;);
                    });
                });
            }).CreateClient(new WebApplicationFactoryClientOptions
            {
                AllowAutoRedirect = false,
            });
            DbContextOptions&lt;DatabaseContext&gt; options = new DbContextOptionsBuilder&lt;DatabaseContext&gt;()
                .UseSqlite(&quot;Data Source = VetAppointmentTest6.db&quot;).Options;
            DatabaseContext db = new DatabaseContext(options);
            db.RemoveRange(db.Vets.ToList());
            db.RemoveRange(db.Pets.ToList());
            db.RemoveRange(db.Appointments.ToList());
            db.RemoveRange(db.VetClinics.ToList());
            db.SaveChanges();

            // Arrange
            var createVetClinicDto = CreateClinitSUT();
            var createClinicResponse = await HttpClient.PostAsJsonAsync(ApiURL, createVetClinicDto);
            var pets = new List&lt;PetDto&gt; { CreatePetSUT() };
            var clinic = await createClinicResponse.Content.ReadFromJsonAsync&lt;VetClinicDto&gt;();

            // Act
            var resultResponse = await HttpClient.PostAsJsonAsync($&quot;{ApiURL}/{clinic.Id}/pets&quot;, pets);

            // Assert
            //resultResponse();
            resultResponse.StatusCode.Should().Be(HttpStatusCode.Created);
        }

        [Fact]
        public async void When_RegisterEmptyListOfPetsToClinic_Then_ShouldReturnBadRequestAsync()
        {
            var HttpClient = _factory.WithWebHostBuilder(builder =&gt;
            {
                builder.ConfigureTestServices(services =&gt;
                {
                    services.AddDbContext&lt;DatabaseContext&gt;(options =&gt;
                    {
                        options.UseSqlite(&quot;Data Source = VetAppointmentTest5.db&quot;);
                    });
                });
            }).CreateClient(new WebApplicationFactoryClientOptions
            {
                AllowAutoRedirect = false,
            });
            DbContextOptions&lt;DatabaseContext&gt; options = new DbContextOptionsBuilder&lt;DatabaseContext&gt;()
                .UseSqlite(&quot;Data Source = VetAppointmentTest5.db&quot;).Options;
            DatabaseContext db = new DatabaseContext(options);
            db.RemoveRange(db.Vets.ToList());
            db.RemoveRange(db.Pets.ToList());
            db.RemoveRange(db.Appointments.ToList());
            db.RemoveRange(db.VetClinics.ToList());
            db.SaveChanges();
 
            // Arrange
            CreateVetClinicDto createVetClinicDto = CreateClinitSUT();
            var createClinicResponse = await HttpClient.PostAsJsonAsync(ApiURL, createVetClinicDto);
            var pets = new List&lt;PetDto&gt;();
            var clinic = await createClinicResponse.Content.ReadFromJsonAsync&lt;VetClinicDto&gt;();

            // Act
            var resultResponse = await HttpClient.PostAsJsonAsync($&quot;{ApiURL}/{clinic.Id}/pets&quot;, pets);

            // Assert
            resultResponse.StatusCode.Should().Be(System.Net.HttpStatusCode.BadRequest);
        }

        [Fact]
        public async void When_RegisterVetToClinic_Then_ShouldSaveVetInClinicAsync()
        {
            var HttpClient = _factory.WithWebHostBuilder(builder =&gt;
            {
                builder.ConfigureTestServices(services =&gt;
                {
                    services.AddDbContext&lt;DatabaseContext&gt;(options =&gt;
                    {
                        options.UseSqlite(&quot;Data Source = VetAppointmentTest4.db&quot;);
                    });
                });
            }).CreateClient(new WebApplicationFactoryClientOptions
            {
                AllowAutoRedirect = false,
            });
            DbContextOptions&lt;DatabaseContext&gt; options = new DbContextOptionsBuilder&lt;DatabaseContext&gt;()
                .UseSqlite(&quot;Data Source = VetAppointmentTest4.db&quot;).Options;
            DatabaseContext db = new DatabaseContext(options);
            db.RemoveRange(db.Vets.ToList());
            db.RemoveRange(db.Pets.ToList());
            db.RemoveRange(db.Appointments.ToList());
            db.RemoveRange(db.VetClinics.ToList());
            db.SaveChanges();
            // Arrange
            var createVetClinicDto = CreateClinitSUT();
            var createClinicResponse = await HttpClient.PostAsJsonAsync(ApiURL, createVetClinicDto);
            var vet = CreateVetSUT();
            var clinic = await createClinicResponse.Content.ReadFromJsonAsync&lt;VetClinicDto&gt;();

            // Act
            var resultResponse = await HttpClient.PostAsJsonAsync($&quot;{ApiURL}/{clinic.Id}/vet&quot;, vet);

            // Assert
            resultResponse.EnsureSuccessStatusCode();
            resultResponse.StatusCode.Should().Be(HttpStatusCode.Created);
        }

        [Fact]
        public async void When_UpdateVet_Then_ShouldUpdateVetInClinic()
        {
            var HttpClient = _factory.WithWebHostBuilder(builder =&gt;
            {
                builder.ConfigureTestServices(services =&gt;
                {
                    services.AddDbContext&lt;DatabaseContext&gt;(options =&gt;
                    {
                        options.UseSqlite(&quot;Data Source = VetAppointmentTest3.db&quot;);
                    });
                });
            }).CreateClient(new WebApplicationFactoryClientOptions
            {
                AllowAutoRedirect = false,
            });
            DbContextOptions&lt;DatabaseContext&gt; options = new DbContextOptionsBuilder&lt;DatabaseContext&gt;()
                .UseSqlite(&quot;Data Source = VetAppointmentTest3.db&quot;).Options;
            DatabaseContext db = new DatabaseContext(options);
            db.RemoveRange(db.Vets.ToList());
            db.RemoveRange(db.Pets.ToList());
            db.RemoveRange(db.Appointments.ToList());
            db.RemoveRange(db.VetClinics.ToList());
            db.SaveChanges();
            // Arrange
            var clinicSUT = CreateClinitSUT();
            var createClinicResponse = await HttpClient.PostAsJsonAsync(ApiURL, clinicSUT);
            var clinic = await createClinicResponse.Content.ReadFromJsonAsync&lt;VetClinicDto&gt;();

            var vetSUT = CreateVetSUT();
            var resultResponse = await HttpClient.PostAsJsonAsync($&quot;{ApiURL}/{clinic.Id}/vet&quot;, vetSUT);
            var vet = await resultResponse.Content.ReadFromJsonAsync&lt;VetDto&gt;();

            vet.Name = &quot;UpdatedFirstName&quot;;

            // Act
            var updateVetResponse = await HttpClient.PutAsJsonAsync($&quot;{ApiURL}/{clinic.Id}/vet/{vet.Id}&quot;, vet);

            // Assert
            updateVetResponse.EnsureSuccessStatusCode();
            updateVetResponse.StatusCode.Should().Be(HttpStatusCode.NoContent);
        }

        [Fact]
        public async void When_DeleteVet_Then_ShouldDeleteVetFromClinic()
        {
            var HttpClient = _factory.WithWebHostBuilder(builder =&gt;
            {
                builder.ConfigureTestServices(services =&gt;
                {
                    services.AddDbContext&lt;DatabaseContext&gt;(options =&gt;
                    {
                        options.UseSqlite(&quot;Data Source = VetAppointmentTest2.db&quot;);
                    });
                });
            }).CreateClient(new WebApplicationFactoryClientOptions
            {
                AllowAutoRedirect = false,
            });
            DbContextOptions&lt;DatabaseContext&gt; options = new DbContextOptionsBuilder&lt;DatabaseContext&gt;()
                .UseSqlite(&quot;Data Source = VetAppointmentTest2.db&quot;).Options;
            DatabaseContext db = new DatabaseContext(options);
            db.RemoveRange(db.Vets.ToList());
            db.RemoveRange(db.Pets.ToList());
            db.RemoveRange(db.Appointments.ToList());
            db.RemoveRange(db.VetClinics.ToList());
            db.SaveChanges();

            // Arrange
            var clinicSUT = CreateClinitSUT();
            var createClinicResponse = await HttpClient.PostAsJsonAsync(ApiURL, clinicSUT);
            var clinic = await createClinicResponse.Content.ReadFromJsonAsync&lt;VetClinicDto&gt;();

            var vetSUT = CreateVetSUT();
            var resultResponse = await HttpClient.PostAsJsonAsync($&quot;{ApiURL}/{clinic.Id}/vet&quot;, vetSUT);
            var vet = await resultResponse.Content.ReadFromJsonAsync&lt;VetDto&gt;();

            // Act
            var deleteVetResponse = await HttpClient.DeleteAsync($&quot;{ApiURL}/{clinic.Id}/vet/{vet.Id}&quot;);

            // Assert
            deleteVetResponse.EnsureSuccessStatusCode();
            deleteVetResponse.StatusCode.Should().Be(HttpStatusCode.NoContent);
        }

        [Fact]
        public async void When_DeleteClinic_Then_ShouldDeleteClinic()
        {
            var HttpClient = _factory.WithWebHostBuilder(builder =&gt;
            {
                builder.ConfigureTestServices(services =&gt;
                {
                    services.AddDbContext&lt;DatabaseContext&gt;(options =&gt;
                    {
                        options.UseSqlite(&quot;Data Source = VetAppointmentTest1.db&quot;);
                    });
                });
            }).CreateClient(new WebApplicationFactoryClientOptions
            {
                AllowAutoRedirect = false,
            });
            DbContextOptions&lt;DatabaseContext&gt; options = new DbContextOptionsBuilder&lt;DatabaseContext&gt;()
                .UseSqlite(&quot;Data Source = VetAppointmentTest1.db&quot;).Options;
            DatabaseContext db = new DatabaseContext(options);
            db.RemoveRange(db.Vets.ToList());
            db.RemoveRange(db.Pets.ToList());
            db.RemoveRange(db.Appointments.ToList());
            db.RemoveRange(db.VetClinics.ToList());
            db.SaveChanges();

            // Arrange
            var clinicSUT = CreateClinitSUT();
            var createClinicResponse = await HttpClient.PostAsJsonAsync(ApiURL, clinicSUT);
            var clinic = await createClinicResponse.Content.ReadFromJsonAsync&lt;VetClinicDto&gt;();

            // Act
            var deleteClinicResponse = await HttpClient.DeleteAsync($&quot;{ApiURL}/{clinic.Id}&quot;);

            // Assert
            deleteClinicResponse.EnsureSuccessStatusCode();
            deleteClinicResponse.StatusCode.Should().Be(HttpStatusCode.NoContent);
        }

        private static CreateVetClinicDto CreateClinitSUT()
        {
            return new CreateVetClinicDto()
            {
                Name = &quot;Pet Lovers&quot;,
                Address = &quot;strada animalutelor&quot;,
                NumberOfPlaces = 3,
                ContactEmail = &quot;love@pets.com&quot;,
                ContactPhone = &quot;+40742845280&quot;
            };
        }

        private static PetDto CreatePetSUT()
        {
            return new PetDto()
            {
                Name = &quot;Bobita&quot;,
                Birthdate = DateTime.Now.AddYears(-1).ToString(),
                Race = AnimalRace.Rabbit.ToString(),
                Gender = AnimalGender.Male.ToString()
            };
        }

        private static VetDto CreateVetSUT()
        {
            return new VetDto()
            {
                Name = &quot;Maria&quot;,
                Surname = &quot;Popovici&quot;,
                Birthdate = DateTime.Now.AddYears(-32).ToString(),
                Email = &quot;maria.popovici@gmail.com&quot;,
                Phone = &quot;+40123456789&quot;,
                Gender = PersonGender.Female.ToString(),
                Specialisation = VetSpecialisation.Nutritionist.ToString()
            };
        }

        public void Dispose()
        {
            CleanDatabases();
        }
    }
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[17,97,17,110,1],[18,9,18,10,1],[19,9,19,10,1],[23,9,23,10,1],[24,13,25,13,1],[25,13,25,14,1],[25,14,26,17,1],[26,17,27,17,1],[27,17,27,18,1],[27,18,28,21,1],[28,21,29,21,1],[29,21,29,22,1],[29,22,30,25,1],[30,25,30,83,1],[30,83,31,21,1],[31,21,31,22,1],[31,22,31,24,1],[31,24,32,17,1],[32,17,32,18,1],[32,18,32,20,1],[32,20,33,13,1],[33,13,33,14,1],[33,14,36,16,1],[37,13,38,76,1],[39,13,39,63,1],[40,13,40,46,1],[41,13,41,46,1],[42,13,42,54,1],[43,13,43,52,1],[44,13,44,30,1],[47,13,47,65,1],[50,13,50,95,1],[51,13,51,69,1],[54,13,54,60,1],[55,13,55,81,1],[57,13,57,55,1],[58,13,58,97,1],[60,13,60,43,1],[61,13,61,42,1],[62,9,62,10,1],[66,9,66,10,1],[67,13,68,13,1],[68,13,68,14,1],[68,14,69,17,1],[69,17,70,17,1],[70,17,70,18,1],[70,18,71,21,1],[71,21,72,21,1],[72,21,72,22,1],[72,22,73,25,1],[73,25,73,83,1],[73,83,74,21,1],[74,21,74,22,1],[74,22,74,24,1],[74,24,75,17,1],[75,17,75,18,1],[75,18,75,20,1],[75,20,76,13,1],[76,13,76,14,1],[76,14,79,16,1],[80,13,81,76,1],[82,13,82,63,1],[83,13,83,46,1],[84,13,84,46,1],[85,13,85,54,1],[86,13,86,52,1],[87,13,87,30,1],[90,13,90,56,1],[91,13,91,101,1],[92,13,92,60,1],[93,13,93,95,1],[96,13,96,103,1],[100,13,100,75,1],[101,9,101,10,1],[105,9,105,10,1],[106,13,107,13,1],[107,13,107,14,1],[107,14,108,17,1],[108,17,109,17,1],[109,17,109,18,1],[109,18,110,21,1],[110,21,111,21,1],[111,21,111,22,1],[111,22,112,25,1],[112,25,112,83,1],[112,83,113,21,1],[113,21,113,22,1],[113,22,113,24,1],[113,24,114,17,1],[114,17,114,18,1],[114,18,114,20,1],[114,20,115,13,1],[115,13,115,14,1],[115,14,118,16,1],[119,13,120,76,1],[121,13,121,63,1],[122,13,122,46,1],[123,13,123,46,1],[124,13,124,54,1],[125,13,125,52,1],[126,13,126,30,1],[129,13,129,71,1],[130,13,130,101,1],[131,13,131,43,1],[132,13,132,95,1],[135,13,135,103,1],[138,13,138,89,1],[139,9,139,10,1],[143,9,143,10,1],[144,13,145,13,1],[145,13,145,14,1],[145,14,146,17,1],[146,17,147,17,1],[147,17,147,18,1],[147,18,148,21,1],[148,21,149,21,1],[149,21,149,22,1],[149,22,150,25,1],[150,25,150,83,1],[150,83,151,21,1],[151,21,151,22,1],[151,22,151,24,1],[151,24,152,17,1],[152,17,152,18,1],[152,18,152,20,1],[152,20,153,13,1],[153,13,153,14,1],[153,14,156,16,1],[157,13,158,76,1],[159,13,159,63,1],[160,13,160,46,1],[161,13,161,46,1],[162,13,162,54,1],[163,13,163,52,1],[164,13,164,30,1],[166,13,166,56,1],[167,13,167,101,1],[168,13,168,38,1],[169,13,169,95,1],[172,13,172,101,1],[175,13,175,54,1],[176,13,176,75,1],[177,9,177,10,1],[181,9,181,10,1],[182,13,183,13,1],[183,13,183,14,1],[183,14,184,17,1],[184,17,185,17,1],[185,17,185,18,1],[185,18,186,21,1],[186,21,187,21,1],[187,21,187,22,1],[187,22,188,25,1],[188,25,188,83,1],[188,83,189,21,1],[189,21,189,22,1],[189,22,189,24,1],[189,24,190,17,1],[190,17,190,18,1],[190,18,190,20,1],[190,20,191,13,1],[191,13,191,14,1],[191,14,194,16,1],[195,13,196,76,1],[197,13,197,63,1],[198,13,198,46,1],[199,13,199,46,1],[200,13,200,54,1],[201,13,201,52,1],[202,13,202,30,1],[204,13,204,47,1],[205,13,205,92,1],[206,13,206,95,1],[208,13,208,41,1],[209,13,209,104,1],[210,13,210,80,1],[212,13,212,43,1],[215,13,215,112,1],[218,13,218,57,1],[219,13,219,80,1],[220,9,220,10,1],[224,9,224,10,1],[225,13,226,13,1],[226,13,226,14,1],[226,14,227,17,1],[227,17,228,17,1],[228,17,228,18,1],[228,18,229,21,1],[229,21,230,21,1],[230,21,230,22,1],[230,22,231,25,1],[231,25,231,83,1],[231,83,232,21,1],[232,21,232,22,1],[232,22,232,24,1],[232,24,233,17,1],[233,17,233,18,1],[233,18,233,20,1],[233,20,234,13,1],[234,13,234,14,1],[234,14,237,16,1],[238,13,239,76,1],[240,13,240,63,1],[241,13,241,46,1],[242,13,242,46,1],[243,13,243,54,1],[244,13,244,52,1],[245,13,245,30,1],[248,13,248,47,1],[249,13,249,92,1],[250,13,250,95,1],[252,13,252,41,1],[253,13,253,104,1],[254,13,254,80,1],[257,13,257,104,1],[260,13,260,57,1],[261,13,261,80,1],[262,9,262,10,1],[266,9,266,10,1],[267,13,268,13,1],[268,13,268,14,1],[268,14,269,17,1],[269,17,270,17,1],[270,17,270,18,1],[270,18,271,21,1],[271,21,272,21,1],[272,21,272,22,1],[272,22,273,25,1],[273,25,273,83,1],[273,83,274,21,1],[274,21,274,22,1],[274,22,274,24,1],[274,24,275,17,1],[275,17,275,18,1],[275,18,275,20,1],[275,20,276,13,1],[276,13,276,14,1],[276,14,279,16,1],[280,13,281,76,1],[282,13,282,63,1],[283,13,283,46,1],[284,13,284,46,1],[285,13,285,54,1],[286,13,286,52,1],[287,13,287,30,1],[290,13,290,47,1],[291,13,291,92,1],[292,13,292,95,1],[295,13,295,94,1],[298,13,298,60,1],[299,13,299,83,1],[300,9,300,10,1],[303,9,303,10,1],[304,13,311,15,1],[312,9,312,10,1],[315,9,315,10,1],[316,13,322,15,1],[323,9,323,10,1],[326,9,326,10,1],[327,13,336,15,1],[337,9,337,10,1],[340,9,340,10,1],[341,13,341,30,1],[342,9,342,10,1]]);
    </script>
  </body>
</html>