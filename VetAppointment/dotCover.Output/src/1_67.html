<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>D:\10.12.2022\VetAppointment\VetAppointment.Integration.Test\DrugTests.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using Microsoft.AspNetCore.Mvc.Testing;
using Microsoft.AspNetCore.TestHost;
using Microsoft.EntityFrameworkCore;
using Microsoft.Extensions.DependencyInjection;
using VetAppointment.API.Controllers;
using VetAppointment.Infrastructure.Data;
using VetAppointment.Integration.Tests;

namespace VetAppointment.Integration.Test
{
    public class DrugTests : BaseIntegrationTests
    {

        private const string ApiURL = &quot;v1/api/drugs&quot;;

        public DrugTests(WebApplicationFactory&lt;VetClinicsController&gt; factory) : base(factory)
        {
        }

        [Fact]
        public async void When_CreateDrugWithValidData_Then_ShouldAddToDataBase()
        {
            var HttpClient = _factory.WithWebHostBuilder(builder =&gt;
            {
                builder.ConfigureTestServices(services =&gt;
                {
                    services.AddDbContext&lt;DatabaseContext&gt;(options =&gt;
                    {
                        options.UseSqlite(&quot;Data Source = VetAppointmentTest10.db&quot;);
                    });
                });
            }).CreateClient(new WebApplicationFactoryClientOptions
            {
                AllowAutoRedirect = false,
            });
            DbContextOptions&lt;DatabaseContext&gt; options = new DbContextOptionsBuilder&lt;DatabaseContext&gt;()
                .UseSqlite(&quot;Data Source = VetAppointmentTest10.db&quot;).Options;
            DatabaseContext db = new DatabaseContext(options);
            db.RemoveRange(db.Drugs.ToList());
            db.SaveChanges();

            //Arrange
            var drugSUT = CreateDrugSUT();

            // Act
            var createDrugResponse = await HttpClient.PostAsJsonAsync(ApiURL, drugSUT);
            var getDrugResult = await HttpClient.GetAsync(ApiURL);

            // Assert
            createDrugResponse.EnsureSuccessStatusCode();
            createDrugResponse.StatusCode.Should().Be(HttpStatusCode.Created);

            getDrugResult.EnsureSuccessStatusCode();
            var clinics = await getDrugResult.Content.ReadFromJsonAsync&lt;List&lt;VetClinicDto&gt;&gt;();

            clinics.Should().HaveCount(1);
            clinics.Should().NotBeNull();
        }

        private static DrugDto CreateDrugSUT()
        {
            return new DrugDto
            {
                Name = &quot;Aspirina Saracului&quot;,
                Quantity = 9999,
                UnitPrice = 0.1
            };
        }
    }
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[16,81,16,94,1],[17,9,17,10,1],[18,9,18,10,1],[22,9,22,10,1],[23,13,24,13,1],[24,13,24,14,1],[24,14,25,17,1],[25,17,26,17,1],[26,17,26,18,1],[26,18,27,21,1],[27,21,28,21,1],[28,21,28,22,1],[28,22,29,25,1],[29,25,29,84,1],[29,84,30,21,1],[30,21,30,22,1],[30,22,30,24,1],[30,24,31,17,1],[31,17,31,18,1],[31,18,31,20,1],[31,20,32,13,1],[32,13,32,14,1],[32,14,35,16,1],[36,13,37,77,1],[38,13,38,63,1],[39,13,39,47,1],[40,13,40,30,1],[43,13,43,43,1],[46,13,46,88,1],[47,13,47,67,1],[50,13,50,58,1],[51,13,51,79,1],[53,13,53,53,1],[54,13,54,95,1],[56,13,56,43,1],[57,13,57,42,1],[58,9,58,10,1],[61,9,61,10,1],[62,13,67,15,1],[68,9,68,10,1]]);
    </script>
  </body>
</html>