<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>D:\10.12.2022\VetAppointment\VetAppointment.API\Controllers\AppointmentsController.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using Microsoft.AspNetCore.Mvc;
using VetAppointment.API.Dtos;
using VetAppointment.API.Dtos.Create;
using VetAppointment.Domain;
using VetAppointment.Infrastructure.Data;

namespace VetAppointment.API.Controllers
{
    [Route(&quot;v1/api/[controller]&quot;)]
    [ApiController]
    public class AppointmentsController : ControllerBase
    {
        private readonly IUnitOfWork unitOfWork;

        public AppointmentsController(IUnitOfWork unitOfWork) =&gt; this.unitOfWork = unitOfWork;

        [HttpPost]
        public IActionResult Create([FromBody] CreateAppointmentDto appointmentDto)
        {
            var pet = unitOfWork.PetRepository.Get(appointmentDto.PetId).Result;
            if (pet == null)
            {
                return NotFound();
            }
            
            var vet = unitOfWork.VetRepository.Get(appointmentDto.VetId).Result;
            if (vet == null)
            {
                return NotFound();
            }
            
            var appointment = Appointment.SettleAppointment(
                    vet,
                    pet,
                    appointmentDto.ScheduledDate,
                    appointmentDto.EstimatedDurationInMinutes
                );

            var treatement = unitOfWork.TreatmentRepository.Get(appointmentDto.TreatmentId).Result;
            if (treatement == null )
            {
                return NotFound();
            }

            var history = unitOfWork.MedicalHistoryRepository.Get(appointmentDto.MedicalHistoryId).Result;
            if (history == null)
            {
                return NotFound();
            }

            history.RegisterAppointmentToHistory(appointment.Entity);
            unitOfWork.MedicalHistoryRepository.Update(history);
            unitOfWork.SaveChanges();

            appointment.Entity.AttachTreatmentToAppointment(treatement);
            appointment.Entity.AttachAppointmentToMedicalHistory(history);


            if (appointment.IsFailure)
            {
                return BadRequest(appointment.Error);
            }

            unitOfWork.AppointmentRepository.Add(appointment.Entity);
            unitOfWork.SaveChanges();
            var fullAppointment = new AppointmentDto
            {
                Id = appointment.Entity.Id,
                VetId = appointment.Entity.VetId,
                PetId = appointment.Entity.PetId,
                ScheduledDate = appointment.Entity.ScheduledDate.ToString(),
                EstimatedDurationInMinutes = appointment.Entity.EstimatedDurationInMinutes
            };

            Response.Headers.Add(&quot;Access-Control-Allow-Headers&quot;, &quot;Content-Type, x-requested-with&quot;);
            Response.Headers.Add(&quot;Access-Control-Allow-Methods&quot;, &quot;GET, POST, OPTIONS, PUT, DELETE&quot;);
            Response.Headers.Add(&quot;Access-Control-Allow-Origin&quot;, &quot;https://localhost:7029&quot;);
            return Created(nameof(GetAllAppointments), fullAppointment);
        }

        [HttpGet]
        public IActionResult GetAllAppointments()
        {
            var appointments = unitOfWork.AppointmentRepository.All().Result.Select(appointment =&gt; new AppointmentDto()
            {
                Id = appointment.Id,
                VetId = appointment.VetId,
                PetId = appointment.PetId,
                ScheduledDate = appointment.ScheduledDate.ToString(),
                EstimatedDurationInMinutes = appointment.EstimatedDurationInMinutes,
                TreatmentId = appointment.TreatmentId,
                MedicalHistoryId = appointment.MedicalHistoryId
            });

            Response.Headers.Add(&quot;Access-Control-Allow-Headers&quot;, &quot;Content-Type, x-requested-with&quot;);
            Response.Headers.Add(&quot;Access-Control-Allow-Methods&quot;, &quot;GET, POST, OPTIONS, PUT, DELETE&quot;);
            Response.Headers.Add(&quot;Access-Control-Allow-Origin&quot;, &quot;https://localhost:7029&quot;);
            return Ok(appointments);
        }

        [HttpGet(&quot;{id}&quot;)]
        public IActionResult GetAppointmentById(Guid id)
        {
            var appointment = unitOfWork.AppointmentRepository.Get(id).Result;
            if (appointment == null)
            {
                return NotFound();
            }

            var appointmentDto = new AppointmentDto
            {
                Id = appointment.Id,
                VetId = appointment.VetId,
                PetId = appointment.PetId,
                ScheduledDate = appointment.ScheduledDate.ToString(),
                EstimatedDurationInMinutes = appointment.EstimatedDurationInMinutes,
                TreatmentId = appointment.TreatmentId,
                MedicalHistoryId = appointment.MedicalHistoryId
            };

            Response.Headers.Add(&quot;Access-Control-Allow-Headers&quot;, &quot;Content-Type, x-requested-with&quot;);
            Response.Headers.Add(&quot;Access-Control-Allow-Methods&quot;, &quot;GET, POST, OPTIONS, PUT, DELETE&quot;);
            Response.Headers.Add(&quot;Access-Control-Allow-Origin&quot;, &quot;https://localhost:7029&quot;);
            return Ok(appointmentDto);
        }

        [HttpDelete(&quot;{id}&quot;)]
        public IActionResult DeleteAppointment(Guid id)
        {
            var appointment = unitOfWork.AppointmentRepository.Get(id).Result;
            if (appointment == null)
            {
                return NotFound();
            }

            unitOfWork.AppointmentRepository.Delete(appointment);
            unitOfWork.SaveChanges();

            Response.Headers.Add(&quot;Access-Control-Allow-Headers&quot;, &quot;Content-Type, x-requested-with&quot;);
            Response.Headers.Add(&quot;Access-Control-Allow-Methods&quot;, &quot;GET, POST, OPTIONS, PUT, DELETE&quot;);
            Response.Headers.Add(&quot;Access-Control-Allow-Origin&quot;, &quot;https://localhost:7029&quot;);
            return NoContent();
        }

        [HttpPut(&quot;{id}&quot;)]
        public IActionResult UpdateAppointment(Guid id, [FromBody] AppointmentDto appointmentDto)
        {
            var appointment = unitOfWork.AppointmentRepository.Get(id).Result;
            if (appointment == null)
            {
                return NotFound();
            }

            appointment.Update(appointment.VetId, appointmentDto.PetId, appointmentDto.ScheduledDate,
                appointmentDto.EstimatedDurationInMinutes, appointmentDto.TreatmentId, appointmentDto.MedicalHistoryId);

            unitOfWork.AppointmentRepository.Update(appointment);
            unitOfWork.SaveChanges();

            Response.Headers.Add(&quot;Access-Control-Allow-Headers&quot;, &quot;Content-Type, x-requested-with&quot;);
            Response.Headers.Add(&quot;Access-Control-Allow-Methods&quot;, &quot;GET, POST, OPTIONS, PUT, DELETE&quot;);
            Response.Headers.Add(&quot;Access-Control-Allow-Origin&quot;, &quot;https://localhost:7029&quot;);
            return NoContent();
        }
    }
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[15,9,15,62,0],[15,66,15,94,0],[19,9,19,10,0],[20,13,20,81,0],[21,13,21,29,0],[22,13,22,14,0],[23,17,23,35,0],[26,13,26,81,0],[27,13,27,29,0],[28,13,28,14,0],[29,17,29,35,0],[32,13,37,19,0],[39,13,39,100,0],[40,13,40,37,0],[41,13,41,14,0],[42,17,42,35,0],[45,13,45,107,0],[46,13,46,33,0],[47,13,47,14,0],[48,17,48,35,0],[51,13,51,70,0],[52,13,52,65,0],[53,13,53,38,0],[55,13,55,73,0],[56,13,56,75,0],[59,13,59,39,0],[60,13,60,14,0],[61,17,61,54,0],[64,13,64,70,0],[65,13,65,38,0],[66,13,73,15,0],[75,13,75,100,0],[76,13,76,101,0],[77,13,77,91,0],[78,13,78,73,0],[79,9,79,10,0],[83,9,83,10,0],[84,13,84,100,0],[84,100,93,14,0],[93,14,93,16,0],[95,13,95,100,0],[96,13,96,101,0],[97,13,97,91,0],[98,13,98,37,0],[99,9,99,10,0],[103,9,103,10,0],[104,13,104,79,0],[105,13,105,37,0],[106,13,106,14,0],[107,17,107,35,0],[110,13,119,15,0],[121,13,121,100,0],[122,13,122,101,0],[123,13,123,91,0],[124,13,124,39,0],[125,9,125,10,0],[129,9,129,10,0],[130,13,130,79,0],[131,13,131,37,0],[132,13,132,14,0],[133,17,133,35,0],[136,13,136,66,0],[137,13,137,38,0],[139,13,139,100,0],[140,13,140,101,0],[141,13,141,91,0],[142,13,142,32,0],[143,9,143,10,0],[147,9,147,10,0],[148,13,148,79,0],[149,13,149,37,0],[150,13,150,14,0],[151,17,151,35,0],[154,13,155,121,0],[157,13,157,66,0],[158,13,158,38,0],[160,13,160,100,0],[161,13,161,101,0],[162,13,162,91,0],[163,13,163,32,0],[164,9,164,10,0]]);
    </script>
  </body>
</html>