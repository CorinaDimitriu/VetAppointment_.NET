<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>D:\10.12.2022\VetAppointment\VetAppointment.API\Controllers\TreatmentsController.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using Microsoft.AspNetCore.Mvc;
using VetAppointment.API.Dtos;
using VetAppointment.API.Dtos.Create;
using VetAppointment.Application;
using VetAppointment.Domain;
using VetAppointment.Infrastructure.Data;

namespace VetAppointment.API.Controllers
{
    [Route(&quot;v1/api/[controller]&quot;)]
    [ApiController]
    public class TreatmentsController : ControllerBase
    {
        private readonly IUnitOfWork unitOfWork;

        public TreatmentsController(IUnitOfWork unitOfWork) =&gt; this.unitOfWork = unitOfWork;

        [HttpGet]
        public IActionResult Get()
        {
            var treatments = unitOfWork.TreatmentRepository
                .All().Result
                .Select ( t =&gt; new TreatmentDto { Id = t.Id, Description = t.Description } );

            Response.Headers.Add(&quot;Access-Control-Allow-Headers&quot;, &quot;Content-Type, x-requested-with&quot;);
            Response.Headers.Add(&quot;Access-Control-Allow-Methods&quot;, &quot;GET, POST, OPTIONS, PUT, DELETE&quot;);
            Response.Headers.Add(&quot;Access-Control-Allow-Origin&quot;, &quot;https://localhost:7029&quot;);
            return Ok(treatments);
        }

        [HttpPost]
        public IActionResult Create([FromBody] CreateTreatmentDto treatmentDto)
        {
            var treat = Treatment.Create(treatmentDto.Description);
            if (treat.IsFailure)
            {
                return BadRequest(treat.Error);
            }

            unitOfWork.TreatmentRepository.Add(treat.Entity);
            unitOfWork.SaveChanges();

            var fullTreatment = new TreatmentDto()
            {
                Id = treat.Entity.Id,
                Description = treat.Entity.Description
            };

            Response.Headers.Add(&quot;Access-Control-Allow-Headers&quot;, &quot;Content-Type, x-requested-with&quot;);
            Response.Headers.Add(&quot;Access-Control-Allow-Methods&quot;, &quot;GET, POST, OPTIONS, PUT, DELETE&quot;);
            Response.Headers.Add(&quot;Access-Control-Allow-Origin&quot;, &quot;https://localhost:7029&quot;);
            return Created(nameof(Get), fullTreatment);
        }

        [HttpPost(&quot;{treatmentId:Guid}/prescribedDrugs&quot;)]
        public IActionResult AddDrugsToTreatment(Guid treatmentId, 
            [FromBody] List&lt;PrescribedDrugDto&gt; prescribedDrugDtos)
        {
            var treatment = unitOfWork.TreatmentRepository.Get(treatmentId).Result;
            if (treatment == null)
            {
                return NotFound();
            }

            var drugs = prescribedDrugDtos
                .Select(d =&gt; PrescribedDrug.Create(d.Quantity, unitOfWork.DrugRepository.Get(d.DrugId).Result) ).ToList();
            if (drugs.Any(p =&gt; p.IsFailure))
            {
                return BadRequest();
            }

            var result = treatment.AppendDrugsToTreatment(drugs.Select(d =&gt; d.Entity).ToList());
            if (result.IsFailure)
            {
                return BadRequest(result.Error);
            }

            drugs.ForEach(d =&gt; unitOfWork.PrescribedDrugRepository.Add(d.Entity));
            unitOfWork.SaveChanges();

            Response.Headers.Add(&quot;Access-Control-Allow-Headers&quot;, &quot;Content-Type, x-requested-with&quot;);
            Response.Headers.Add(&quot;Access-Control-Allow-Methods&quot;, &quot;GET, POST, OPTIONS, PUT, DELETE&quot;);
            Response.Headers.Add(&quot;Access-Control-Allow-Origin&quot;, &quot;https://localhost:7029&quot;);
            return NoContent();
        }

        [HttpPut(&quot;{treatmentId:Guid}&quot;)]
        public IActionResult UpdateTreatment(Guid treatmentId, [FromBody] CreateTreatmentDto treatmentDto)
        {
            var treatment = unitOfWork.TreatmentRepository.Get(treatmentId).Result;
            if (treatment == null)
            {
                return NotFound();
            }

            var result = treatment.UpdateDescription(treatmentDto.Description);
            if (result.IsFailure)
            {
                return BadRequest(result.Error);
            }

            unitOfWork.TreatmentRepository.Update(treatment);
            unitOfWork.SaveChanges();

            Response.Headers.Add(&quot;Access-Control-Allow-Headers&quot;, &quot;Content-Type, x-requested-with&quot;);
            Response.Headers.Add(&quot;Access-Control-Allow-Methods&quot;, &quot;GET, POST, OPTIONS, PUT, DELETE&quot;);
            Response.Headers.Add(&quot;Access-Control-Allow-Origin&quot;, &quot;https://localhost:7029&quot;);
            return NoContent();
        }

        [HttpPut(&quot;{treatmentId:Guid}/prescribedDrug/{prescribedDrugId:Guid}&quot;)]
        public IActionResult UpdateDrugInTreatment(Guid treatmentId, Guid prescribedDrugId, 
            [FromBody] PrescribedDrugDto prescribedDrugDto)
        {
            var treatment = unitOfWork.TreatmentRepository.Get(treatmentId).Result;
            if (treatment == null)
            {
                return NotFound();
            }

            var drugPrescribed = unitOfWork.PrescribedDrugRepository.Get(prescribedDrugId).Result;
            if (drugPrescribed == null)
            {
                return NotFound();
            }

            var drug = unitOfWork.DrugRepository.Get(prescribedDrugDto.DrugId).Result;
            if (drug == null)
            {
                return NotFound();
            }

            var result = drugPrescribed.Update(prescribedDrugDto.Quantity, drug);

            if (result.IsFailure)
            {
                return BadRequest(result.Error);
            }

            unitOfWork.PrescribedDrugRepository.Update(drugPrescribed);
            unitOfWork.SaveChanges();

            Response.Headers.Add(&quot;Access-Control-Allow-Headers&quot;, &quot;Content-Type, x-requested-with&quot;);
            Response.Headers.Add(&quot;Access-Control-Allow-Methods&quot;, &quot;GET, POST, OPTIONS, PUT, DELETE&quot;);
            Response.Headers.Add(&quot;Access-Control-Allow-Origin&quot;, &quot;https://localhost:7029&quot;);
            return NoContent();
        }

        [HttpDelete(&quot;{treatmentId:Guid}/prescribedDrug/{prescribedDrugId:Guid}&quot;)]
        public IActionResult RemoveDrugFromTreatment(Guid treatmentId, Guid prescribedDrugId)
        {
            var treatment = unitOfWork.TreatmentRepository.Get(treatmentId).Result;
            if (treatment == null)
            {
                return NotFound();
            }

            var drug = unitOfWork.PrescribedDrugRepository.Get(prescribedDrugId).Result;
            if (drug == null)
            {
                return NotFound();
            }

            var result = treatment.RemoveDrugFromTreatment(drug);
            if (result.IsFailure)
            {
                return BadRequest(result.Error);
            }

            unitOfWork.PrescribedDrugRepository.Delete(drug);
            unitOfWork.SaveChanges();

            Response.Headers.Add(&quot;Access-Control-Allow-Headers&quot;, &quot;Content-Type, x-requested-with&quot;);
            Response.Headers.Add(&quot;Access-Control-Allow-Methods&quot;, &quot;GET, POST, OPTIONS, PUT, DELETE&quot;);
            Response.Headers.Add(&quot;Access-Control-Allow-Origin&quot;, &quot;https://localhost:7029&quot;);
            return NoContent();
        }

        [HttpDelete(&quot;{treatmentId:Guid}&quot;)]
        public IActionResult Delete(Guid treatmentId)
        {
            var treatment = unitOfWork.TreatmentRepository.Get(treatmentId).Result;
            if (treatment == null)
            {
                return NotFound();
            }

            unitOfWork.TreatmentRepository.Delete(treatment);
            unitOfWork.SaveChanges();

            Response.Headers.Add(&quot;Access-Control-Allow-Headers&quot;, &quot;Content-Type, x-requested-with&quot;);
            Response.Headers.Add(&quot;Access-Control-Allow-Methods&quot;, &quot;GET, POST, OPTIONS, PUT, DELETE&quot;);
            Response.Headers.Add(&quot;Access-Control-Allow-Origin&quot;, &quot;https://localhost:7029&quot;);
            return NoContent();
        }

    }
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[16,9,16,60,0],[16,64,16,92,0],[20,9,20,10,0],[21,13,23,32,0],[23,32,23,91,0],[23,91,23,94,0],[25,13,25,100,0],[26,13,26,101,0],[27,13,27,91,0],[28,13,28,35,0],[29,9,29,10,0],[33,9,33,10,0],[34,13,34,68,0],[35,13,35,33,0],[36,13,36,14,0],[37,17,37,48,0],[40,13,40,62,0],[41,13,41,38,0],[43,13,47,15,0],[49,13,49,100,0],[50,13,50,101,0],[51,13,51,91,0],[52,13,52,56,0],[53,9,53,10,0],[58,9,58,10,0],[59,13,59,84,0],[60,13,60,35,0],[61,13,61,14,0],[62,17,62,35,0],[65,13,66,30,0],[66,30,66,111,0],[66,111,66,123,0],[67,13,67,32,0],[67,32,67,43,0],[67,43,67,45,0],[68,13,68,14,0],[69,17,69,37,0],[72,13,72,77,0],[72,77,72,85,0],[72,85,72,97,0],[73,13,73,34,0],[74,13,74,14,0],[75,17,75,49,0],[78,13,78,32,0],[78,32,78,81,0],[78,81,78,83,0],[79,13,79,38,0],[81,13,81,100,0],[82,13,82,101,0],[83,13,83,91,0],[84,13,84,32,0],[85,9,85,10,0],[89,9,89,10,0],[90,13,90,84,0],[91,13,91,35,0],[92,13,92,14,0],[93,17,93,35,0],[96,13,96,80,0],[97,13,97,34,0],[98,13,98,14,0],[99,17,99,49,0],[102,13,102,62,0],[103,13,103,38,0],[105,13,105,100,0],[106,13,106,101,0],[107,13,107,91,0],[108,13,108,32,0],[109,9,109,10,0],[114,9,114,10,0],[115,13,115,84,0],[116,13,116,35,0],[117,13,117,14,0],[118,17,118,35,0],[121,13,121,99,0],[122,13,122,40,0],[123,13,123,14,0],[124,17,124,35,0],[127,13,127,87,0],[128,13,128,30,0],[129,13,129,14,0],[130,17,130,35,0],[133,13,133,82,0],[135,13,135,34,0],[136,13,136,14,0],[137,17,137,49,0],[140,13,140,72,0],[141,13,141,38,0],[143,13,143,100,0],[144,13,144,101,0],[145,13,145,91,0],[146,13,146,32,0],[147,9,147,10,0],[151,9,151,10,0],[152,13,152,84,0],[153,13,153,35,0],[154,13,154,14,0],[155,17,155,35,0],[158,13,158,89,0],[159,13,159,30,0],[160,13,160,14,0],[161,17,161,35,0],[164,13,164,66,0],[165,13,165,34,0],[166,13,166,14,0],[167,17,167,49,0],[170,13,170,62,0],[171,13,171,38,0],[173,13,173,100,0],[174,13,174,101,0],[175,13,175,91,0],[176,13,176,32,0],[177,9,177,10,0],[181,9,181,10,0],[182,13,182,84,0],[183,13,183,35,0],[184,13,184,14,0],[185,17,185,35,0],[188,13,188,62,0],[189,13,189,38,0],[191,13,191,100,0],[192,13,192,101,0],[193,13,193,91,0],[194,13,194,32,0],[195,9,195,10,0]]);
    </script>
  </body>
</html>