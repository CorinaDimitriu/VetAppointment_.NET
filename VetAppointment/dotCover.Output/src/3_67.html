<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>D:\10.12.2022\VetAppointment\VetAppointment.Integration.Test\PetOwnersControllerTests.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
#nullable disable
using Microsoft.AspNetCore.Mvc.Testing;
using Microsoft.AspNetCore.TestHost;
using Microsoft.EntityFrameworkCore;
using Microsoft.Extensions.DependencyInjection;
using VetAppointment.API.Controllers;
using VetAppointment.Infrastructure.Data;

namespace VetAppointment.Integration.Tests
{
    public class PetOwnersControllerTests : BaseIntegrationTests
    {
        private const string ApiURL = &quot;v1/api/petowners&quot;;

        public PetOwnersControllerTests(WebApplicationFactory&lt;VetClinicsController&gt; factory) : base(factory)
        {
        }

        [Fact]
        public async Task When_RegisterPetsToOwner_Then_ShouldSavePetsToOwnerAsync()
        {
            // Arrange
            var HttpClient = _factory.WithWebHostBuilder(builder =&gt;
            {
                builder.ConfigureTestServices(services =&gt;
                {
                    services.AddDbContext&lt;DatabaseContext&gt;(options =&gt;
                    {
                        options.UseSqlite(&quot;Data Source = VetAppointmentTest9.db&quot;);
                    });
                });
            }).CreateClient(new WebApplicationFactoryClientOptions
            {
                AllowAutoRedirect = false,
            });
            DbContextOptions&lt;DatabaseContext&gt; options = new DbContextOptionsBuilder&lt;DatabaseContext&gt;()
                .UseSqlite(&quot;Data Source = VetAppointmentTest9.db&quot;).Options;
            DatabaseContext db = new DatabaseContext(options);
            CleanDatabases(db);
            //using (var scope = _factory.Services.CreateScope())
            //{
            //    var scopedServices = scope.ServiceProvider;
            //    var db = scopedServices.GetRequiredService&lt;DatabaseContext&gt;();

            //    db.RemoveRange(db.PetOwners.ToList());
            //    db.RemoveRange(db.VetClinics.ToList());
            //    db.RemoveRange(db.Pets.ToList());
            //    db.SaveChanges();
            //}

            CreatePetOwnerDto createPetOwnerDto = CreateSUT();
            var createPetOwnerResponse = await HttpClient.PostAsJsonAsync(&quot;v1/API/PetOwners&quot;, createPetOwnerDto);
            var pets = new List&lt;PetDto&gt;
            {
                new PetDto
                {
                    Name = &quot;Bobita&quot;,
                    Birthdate = &quot;9/10/2021&quot;,
                    Race = &quot;Dog&quot;,
                    Gender = &quot;Male&quot;
                }
            };
            var petOwner = await createPetOwnerResponse.Content.ReadFromJsonAsync&lt;PetOwnerDto&gt;();

            // Act
            var resultResponse = await HttpClient.PostAsJsonAsync($&quot;{ApiURL}/{petOwner.Id}/pets&quot;, pets);

            // Assert
            resultResponse.EnsureSuccessStatusCode();
            resultResponse.StatusCode.Should().Be(HttpStatusCode.Created);
        }

        [Fact]
        public async void When_RegisterEmptyListOfPetsToOwner_Then_ShouldReturnBadRequestAsync()
        {
            // Arrange
            var HttpClient = _factory.WithWebHostBuilder(builder =&gt;
            {
                builder.ConfigureTestServices(services =&gt;
                {
                    services.AddDbContext&lt;DatabaseContext&gt;(options =&gt;
                    {
                        options.UseSqlite(&quot;Data Source = VetAppointmentTest8.db&quot;);
                    });
                });
            }).CreateClient(new WebApplicationFactoryClientOptions
            {
                AllowAutoRedirect = false,
            });
            DbContextOptions&lt;DatabaseContext&gt; options = new DbContextOptionsBuilder&lt;DatabaseContext&gt;()
                .UseSqlite(&quot;Data Source = VetAppointmentTest8.db&quot;).Options;
            DatabaseContext db = new DatabaseContext(options);
            CleanDatabases(db);
            
            CreatePetOwnerDto createPetOwnerDto = CreateSUT();

            var createPetOwnerResponse = await HttpClient.PostAsJsonAsync(ApiURL, createPetOwnerDto);
            var pets = new List&lt;PetDto&gt;();
            var petOwner = await createPetOwnerResponse.Content.ReadFromJsonAsync&lt;PetOwnerDto&gt;();

            // Act
            var resultResponse = await HttpClient.PostAsJsonAsync($&quot;{ApiURL}/{petOwner.Id}/pets&quot;, pets);

            // Assert
            resultResponse.StatusCode.Should().Be(HttpStatusCode.BadRequest);
        }

        private static CreatePetOwnerDto CreateSUT()
        {
            return new CreatePetOwnerDto
            {
                Name = &quot;Ion&quot;,
                Surname = &quot;Ionescu&quot;,
                Birthdate = &quot;19-10-1986&quot;,
                Gender = &quot;Male&quot;,
                Address = &quot;Iasi&quot;,
                Email = &quot;ion@gmail.com&quot;,
                Phone = &quot;+40732961298&quot;
            };
        }
    }
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[15,96,15,109,1],[16,9,16,10,1],[17,9,17,10,1],[21,9,21,10,1],[23,13,24,13,1],[24,13,24,14,1],[24,14,25,17,1],[25,17,26,17,1],[26,17,26,18,1],[26,18,27,21,1],[27,21,28,21,1],[28,21,28,22,1],[28,22,29,25,1],[29,25,29,83,1],[29,83,30,21,1],[30,21,30,22,1],[30,22,30,24,1],[30,24,31,17,1],[31,17,31,18,1],[31,18,31,20,1],[31,20,32,13,1],[32,13,32,14,1],[32,14,35,16,1],[36,13,37,76,1],[38,13,38,63,1],[39,13,39,32,1],[51,13,51,63,1],[52,13,52,114,1],[53,13,62,15,1],[63,13,63,98,1],[66,13,66,105,1],[69,13,69,54,1],[70,13,70,75,1],[71,9,71,10,1],[75,9,75,10,1],[77,13,78,13,1],[78,13,78,14,1],[78,14,79,17,1],[79,17,80,17,1],[80,17,80,18,1],[80,18,81,21,1],[81,21,82,21,1],[82,21,82,22,1],[82,22,83,25,1],[83,25,83,83,1],[83,83,84,21,1],[84,21,84,22,1],[84,22,84,24,1],[84,24,85,17,1],[85,17,85,18,1],[85,18,85,20,1],[85,20,86,13,1],[86,13,86,14,1],[86,14,89,16,1],[90,13,91,76,1],[92,13,92,63,1],[93,13,93,32,1],[95,13,95,63,1],[97,13,97,102,1],[98,13,98,43,1],[99,13,99,98,1],[102,13,102,105,1],[105,13,105,78,1],[106,9,106,10,1],[109,9,109,10,1],[110,13,119,15,1],[120,9,120,10,1]]);
    </script>
  </body>
</html>